下面是当前仓库里所有 `analyze_*.py` 脚本的用途说明，每个文件一小段话，方便你后面当说明文档使用。

**1. scripts/analyze_plot_atp.py**  
基于开票数据（`order_full_data.parquet`）和 `business_definition.json`，按车型（Series / Series Group）、产品类型和具体车型做 2025 年开票均价（ATP, Average Transaction Price）分析。脚本先用业务规则派生 `series_group`、`product_type` 等字段，再聚合出各细分车型的订单量与平均成交价，并生成 Plotly HTML 报告（如 `atp_analysis.html`），包括订单类型结构表和按车型分组的 ATP 明细表，用于看不同车型/配置的价格水平和结构。

**2. scripts/analyze_plot_lock_ratio.py**  
针对锁单数据绘制“累计同比”趋势，对齐到 2025 年日期轴，比较 2025 vs 2024、2026 vs 2025 的全年累计锁单同比曲线。Tooltip 展示每日锁单数、累计锁单数和累计同比，同时新增 LS6 车型的“增程占比”模块：基于 `series='LS6'` 且 `lock_time >= 2025-09-10`，按日计算增程版本销量占比（MA7 平滑），并画出 2025 和 2026 的趋势及年均占比虚线，最终输出到 Plotly HTML 看板中。

**3. scripts/analyze_pk_diff.py**  
读取“业务数据记录\_竞争PK（LS6）.csv”，针对 LS6 车系的竞品 PK 数据，按周维度做“归因分析”：对比最近 4 周与之前 5–8 周的周均总 PK 量、Top3 竞品集中度等指标，并计算各竞品在两个时段的平均 PK 量和份额变化。脚本生成 HTML 片段/报告，总结近期 PK 变化是整体萎缩、头部收缩还是长尾分散，帮助解释 LS6 PK 表现波动的来源。

**4. ocr_pipeline/analyze_trend.py**  
面向 OCR 流程的日级订单与开票统计，读取 `fact_daily_order_invoice.csv`，构建日序列，分别对“订单数”和“发票数”计算原始值与 7 日移动均值（MA7），并用 Plotly 画出时间序列曲线。脚本还支持 IM vs 上汽等两个实体的对比视图，以及（通过辅助函数）对异常点进行检测，最终生成 HTML 报告，用于监控 OCR 产出与业务数据的一致性、节奏和异常。

**5. scripts/analyze_product_trend.py**  
基于 `order_full_data.parquet` 和业务定义中的时间段配置，以 CM2 结束日及 LS9 上市时间为基准，对 LS6/LS9 的关键产品组合做锁单趋势分析。脚本针对三个模块：① LS6 纯电 76kWh（Max+ vs Max），② CM2 增程 52/66kWh（新一代 LS6 52 Max vs 66 Max），③ LS9 增程 52/66kWh，分别按日聚合锁单量、留存量（排除退订）、退订量及份额曲线，同时导出合并后的 CSV（指标矩阵）和 Plotly HTML 报告，用于复盘不同电池版本和车系的量价/份额走势。

**6. scripts/analyze_2025.py**  
面向年度复盘的“2025 经营 Review”总控脚本，读取 `order_full_data.parquet` 与 `business_definition.json`，按业务定义对订单类型、时间区间等进行统一清洗。脚本围绕锁单数、开票数、退订数、留存锁单数、门店在营天数、门店经营年限分布（Module 4.3.2）等关键指标，分别对 2024 和 2025 做对标分析，计算各类指标的年内分布和结构，并生成 Plotly HTML 报告（`review_2025.html`），作为全年表现和 YoY 对比的总览看板。

**7. scripts/analyze_age_timing.py**  
基于 `order_full_data.parquet` 的锁单明细，先过滤“留存锁单”（退订为空），再用业务定义中的 `series_group_logic` 和 `time_periods` 划分子车型与时间窗，并映射到主系列（LS6、L6、LS9 等）。脚本按年份（2024、2025）和系列，将车主年龄分箱为“00后、95后、90后...”等年龄段，再结合锁单月份或时间段构建二维分布（热力图），输出 `age_timing_heatmap.html`，用于观察不同年龄代际的购车高峰时间与车型偏好差异。

**8. scripts/analyze_plot_leads_normality.py**  
在 `processed/` 目录内自动寻找最新的 `leads_daily_*.csv`，提取每日线索量（优先使用“线索识别数”列），在给定时间区间内，计算样本的均值、标准差、偏度、峰度，并在有 SciPy 时进行 Shapiro-Wilk、D’Agostino K² 和 K-S 正态性检验。脚本用 Plotly 生成包含“直方图+正态拟合曲线”和“Q-Q 图”的 HTML 报告，用于判断日线索量是否可近似视为正态分布，为后续建模或异常检测方法选择提供依据。

**9. scripts/analyze_plot_dash_align.py**  
以 `Core_Metrics_transposed.csv` 为主数据源（可辅以来自 `intention_order_analysis.parquet` 的门店与订单信息），计算 30 日/7 日线索锁单转化率等核心指标，并通过对时间序列进行“对齐到统一起点（Day 0）”的方式，把不同时间窗的指标曲线映射到统一日序。脚本还从订单侧推导“在营门店数”和“锁单-分配时长（天）”的日均时序，用 Plotly 构造多子图（指标曲线 + 对齐结果），方便在看板中统一对齐多个指标的走势，检视节奏与结构变化。

**10. scripts/analyze_plot_owner_age_price.py**  
基于 `intention_order_analysis.parquet`，自动解析车型分组、产品名称、车主年龄、开票价格和区域等字段，对数据进行清洗与车型分类（如区分 LS9、CM2 纯电、CM2 增程）。脚本在可选过滤车型、大区的前提下，以“车主年龄”为横轴、“开票价格（可换算成万元）”为纵轴，按车型分组绘制大规模散点图，并用自实现的高性能 LOWESS 算法画出平滑价格曲线，最终生成 Plotly HTML 报告，用于洞察不同车型价位在各年龄段人群中的受欢迎程度和价格敏感度趋势。

**11. scripts/analyze_causal_forest_battery_effect.py**  
围绕 LS6 CM2 与 LS9 的 52/66kWh 电池版本，使用 `intention_order_analysis.parquet` 和配置明细 CSV（`*_Configuration_Details_transposed_*.csv`）构建样本集，派生出电池容量、官方指导价、0–100 加速、续航里程、电池类型与供应商、选装激光雷达等特征，并融合年龄、性别、区域等用户画像信息。脚本将“是否 66kWh”设为处理变量，分别支持基于 econml 的 CausalForestDML 和自实现的 X-learner，用于估计在控制其他因素后，电池容量升级对销量或份额（可选 outcome="sales"/"share"）的因果效应，并按人群/区域等维度输出异质性效果（CATE）总结。

**12. scripts/analyze_user_to_config_rules.py**  
针对 LS9 订单，从 `intention_order_analysis.parquet` 中抽取 LS9 用户的订单（并可结合重复购车排除名单、配置 CSV 等），构造“用户画像 + 配置项”的事务数据集。脚本将用户特征（地区、性别、年龄分箱、首次触达至锁单时间分箱）统一编码为 `U:*` 前缀，将配置选择（车型、外观色、内饰色、牵引钩、软件包、轮毂等）编码为 `C:*` 前缀，生成可用于 Apriori/Frequent Itemset 的交易列表与 one-hot 矩阵，后续在脚本内部运行关联规则挖掘，输出“某类用户画像 → 某配置组合”的高支持度/置信度规则，为人群化推荐配置提供依据。

**13. scripts/analyze_product_types_preference_by_city.py**  
从 `intention_order_analysis.parquet` 中读取数据，按车型分组筛选指定组（默认 CM2），并在指定锁单时间区间（如 2025-09-10～2025-10-15）内过滤样本。脚本按门店城市（Store City）与产品类型（Product_Types 或通过 Product Name 映射得到的“增程/纯电”）统计订单数，并在每个城市内，将各产品类型的订单数除以该城市订单数最多的类型，得到 0~1 的“偏好度系数”。结果导出为 CSV，用于对比不同城市对增程 vs 纯电等产品类型的相对偏好。

**14. scripts/analyze_plot_leads_aggregated_comparison.py**  
读取线索日度聚合 CSV（手动指定或自动选择 `processed/` 中最新的 `leads_daily_*.csv`），在用户指定的两段时间窗内分别汇总各渠道的线索量。脚本识别数值型渠道列（排除日期、总线索数等汇总列），对每个时间窗计算各渠道的总线索数及结构占比，再将两窗结果按渠道合并，计算占比差异和累计占比。最终用 Plotly 生成“帕累托对比看板”：上半部分为双窗口的渠道占比柱状图 + 累计数量折线，下半部分为包含数量、占比、累计占比和差异的明细表，用于对比前后两阶段的渠道结构变化。

**15. scripts/analyze_plot_channel_share_comparison.py**  
基于 `intention_order_analysis.parquet`，解析锁单时间、首要渠道分组（`first_main_channel_group`）和车型分组字段，在两个时间段内分别筛选锁单订单，并按“渠道 × 车型分组”交叉聚合，得到各渠道中不同车型的锁单数。脚本先计算两个时间段的按渠道总占比及其差异，再构造：① 上方的双周期堆叠柱图（按照渠道，堆叠展示各车型在全周期总量中的占比）；② 中间的渠道明细表（数量/占比/差异）；③ 底部针对两条指定车型线（如 LS9 vs CM2）的渠道占比比较图。整体用于对比两个阶段间各渠道的车型结构变化，特别是 LS9 与 CM2 的渠道表现差异。

**16. analyze_repeat_customers.py**  
从 `intention_order_analysis.parquet` 中识别重复客户：以手机号（必选）和身份证号（如存在）组合为客户标识，找出拥有多个不同订单号的客户，并在统计前过滤掉 L7/LS7 等非关注车型。脚本打印字段检查信息、统计总客户数与重复客户数及比例，并按车型分组汇总重复客户情况，同时将每位重复客户的详细订单轨迹（车型、下单时间、订单序号等）导出为 `repeat_customers_details.csv`，用于识别“多次购买/换购/增购”的客户群体和车型分布。
